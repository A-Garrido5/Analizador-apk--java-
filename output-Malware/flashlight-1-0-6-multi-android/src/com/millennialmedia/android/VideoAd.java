// 
// Decompiled by Procyon v0.5.30
// 

package com.millennialmedia.android;

import java.util.List;
import java.io.ObjectOutput;
import java.io.ObjectInput;
import java.io.FilenameFilter;
import java.util.Iterator;
import java.io.File;
import android.content.Intent;
import org.json.JSONArray;
import android.net.Uri;
import android.content.Context;
import org.json.JSONException;
import org.json.JSONObject;
import android.os.Parcel;
import java.util.ArrayList;
import android.os.Parcelable$Creator;
import java.io.Externalizable;
import android.os.Parcelable;

class VideoAd extends CachedAd implements Parcelable, Externalizable
{
    public static final Parcelable$Creator CREATOR;
    private static final String TAG = "VideoAd";
    static final String VIDEO_FILE_ID = "video.dat";
    static final long serialVersionUID = 2679125946930815832L;
    ArrayList activities;
    ArrayList buttons;
    String[] cacheComplete;
    String[] cacheFailed;
    String cacheMissURL;
    DTOCachedVideo cachedVideoDto;
    long closeDelayMillis;
    long contentLength;
    long duration;
    String[] endActivity;
    String endOverlayURL;
    String onCompletionUrl;
    boolean reloadNonEndOverlayOnRestart;
    boolean showControls;
    boolean showCountdown;
    String[] startActivity;
    boolean stayInPlayer;
    boolean usingInternalStorage;
    String[] videoError;
    private String videoFileId;
    String webOverlayURL;
    
    static {
        CREATOR = (Parcelable$Creator)new Parcelable$Creator() {
            public final VideoAd createFromParcel(final Parcel parcel) {
                return new VideoAd(parcel);
            }
            
            public final VideoAd[] newArray(final int n) {
                return new VideoAd[n];
            }
        };
    }
    
    public VideoAd() {
        this.buttons = new ArrayList();
        this.activities = new ArrayList();
    }
    
    VideoAd(final Parcel parcel) {
        super(parcel);
        this.buttons = new ArrayList();
        this.activities = new ArrayList();
        try {
            parcel.readStringArray(this.startActivity = new String[parcel.readInt()]);
            parcel.readStringArray(this.endActivity = new String[parcel.readInt()]);
            final boolean[] array = new boolean[5];
            parcel.readBooleanArray(array);
            this.showControls = array[0];
            this.stayInPlayer = array[1];
            this.showCountdown = array[2];
            this.reloadNonEndOverlayOnRestart = array[3];
            this.usingInternalStorage = array[4];
            this.onCompletionUrl = parcel.readString();
            this.webOverlayURL = parcel.readString();
            this.endOverlayURL = parcel.readString();
            this.cacheMissURL = parcel.readString();
            this.videoFileId = parcel.readString();
            this.duration = parcel.readLong();
            this.contentLength = parcel.readLong();
            this.closeDelayMillis = parcel.readLong();
            this.buttons = parcel.readArrayList(VideoImage.class.getClassLoader());
            this.activities = parcel.readArrayList(VideoLogEvent.class.getClassLoader());
            parcel.readStringArray(this.cacheComplete = new String[parcel.readInt()]);
            parcel.readStringArray(this.cacheFailed = new String[parcel.readInt()]);
            parcel.readStringArray(this.videoError = new String[parcel.readInt()]);
        }
        catch (Exception ex) {
            MMLog.e("VideoAd", "Exception with videoad parcel creation: ", ex);
        }
    }
    
    VideoAd(final String s) {
        this.buttons = new ArrayList();
        this.activities = new ArrayList();
        if (s == null) {
            return;
        }
        while (true) {
            try {
                final JSONObject jsonObject = new JSONObject(s);
                if (jsonObject != null) {
                    final JSONObject optJSONObject = jsonObject.optJSONObject("video");
                    if (optJSONObject != null) {
                        this.deserializeFromObj(optJSONObject);
                    }
                }
            }
            catch (JSONException ex) {
                MMLog.e("VideoAd", "VideoAd json exception: ", (Throwable)ex);
                final JSONObject jsonObject = null;
                continue;
            }
            break;
        }
    }
    
    static boolean downloadVideoFile(final Context context, final String s, final String s2) {
        final boolean downloadComponentExternalStorage = AdCache.downloadComponentExternalStorage(s, s2 + "video.dat", context);
        MMLog.v("VideoAd", String.format("Caching completed successfully (" + s2 + "video.dat)? %b", downloadComponentExternalStorage));
        return downloadComponentExternalStorage;
    }
    
    static Uri getVideoUri(final Context context, final String s) {
        return Uri.fromFile(AdCache.getDownloadFile(context, s + "video.dat"));
    }
    
    private void handleSharedVideoFile(final Context context) {
        AdCache.iterateCachedAds(context, 2, new VideoAd$VideoIterator(context, this));
    }
    
    static boolean hasVideoFile(final Context context, final String s) {
        return AdCache.hasDownloadFile(context, s + "video.dat");
    }
    
    static void playAd(final Context context, final String s, final HttpRedirection$RedirectionListenerImpl httpRedirection$RedirectionListenerImpl) {
        if (s != null) {
            final VideoAd videoAd = (VideoAd)AdCache.load(context, s);
            if (videoAd == null || !videoAd.canShow(context, null, false)) {
                MMLog.w("VideoAd", String.format("mmvideo: Ad %s cannot be shown at this time.", s));
                return;
            }
            httpRedirection$RedirectionListenerImpl.updateLastVideoViewedTime();
            MMLog.v("VideoAd", String.format("mmvideo: attempting to play video %s", s));
            videoAd.show(context, httpRedirection$RedirectionListenerImpl.creatorAdImplInternalId);
            httpRedirection$RedirectionListenerImpl.startingVideo();
        }
    }
    
    @Override
    boolean canShow(final Context context, final MMAdImpl mmAdImpl, final boolean b) {
        if (b) {
            if (this.isExpired() || !this.isOnDisk(context) || !HandShake.sharedHandShake(context).canDisplayCachedAd(mmAdImpl.adType, this.deferredViewStart)) {
                return false;
            }
        }
        else if (this.isExpired() || !this.isOnDisk(context)) {
            return false;
        }
        return true;
    }
    
    @Override
    void delete(final Context context) {
        super.delete(context);
        this.handleSharedVideoFile(context);
        AdCache.cachedVideoWasRemoved(context, this.acid);
        MMLog.v("VideoAd", String.format("Ad %s was deleted.", this.getId()));
    }
    
    public int describeContents() {
        return 0;
    }
    
    @Override
    protected void deserializeFromObj(final JSONObject jsonObject) {
        super.deserializeFromObj(jsonObject);
        final JSONArray optJSONArray = jsonObject.optJSONArray("startActivity");
        this.webOverlayURL = jsonObject.optString("overlayURL", (String)null);
        this.endOverlayURL = jsonObject.optString("endURL", (String)null);
        this.cacheMissURL = jsonObject.optString("cacheMissURL", (String)null);
        this.videoFileId = jsonObject.optString("videoFileId", (String)null);
        if (optJSONArray != null) {
            this.startActivity = new String[optJSONArray.length()];
            for (int i = 0; i < optJSONArray.length(); ++i) {
                this.startActivity[i] = optJSONArray.optString(i);
            }
        }
        else {
            this.startActivity = new String[0];
        }
        final JSONArray optJSONArray2 = jsonObject.optJSONArray("endActivity");
        if (optJSONArray2 != null) {
            this.endActivity = new String[optJSONArray2.length()];
            for (int j = 0; j < optJSONArray2.length(); ++j) {
                this.endActivity[j] = optJSONArray2.optString(j);
            }
        }
        else {
            this.endActivity = new String[0];
        }
        final JSONArray optJSONArray3 = jsonObject.optJSONArray("cacheComplete");
        if (optJSONArray3 != null) {
            this.cacheComplete = new String[optJSONArray3.length()];
            for (int k = 0; k < optJSONArray3.length(); ++k) {
                this.cacheComplete[k] = optJSONArray3.optString(k);
            }
        }
        else {
            this.cacheComplete = new String[0];
        }
        final JSONArray optJSONArray4 = jsonObject.optJSONArray("cacheFailed");
        if (optJSONArray4 != null) {
            this.cacheFailed = new String[optJSONArray4.length()];
            for (int l = 0; l < optJSONArray4.length(); ++l) {
                this.cacheFailed[l] = optJSONArray4.optString(l);
            }
        }
        else {
            this.cacheFailed = new String[0];
        }
        final JSONArray optJSONArray5 = jsonObject.optJSONArray("videoError");
        if (optJSONArray5 != null) {
            this.videoError = new String[optJSONArray5.length()];
            for (int n = 0; n < optJSONArray5.length(); ++n) {
                this.videoError[n] = optJSONArray5.optString(n);
            }
        }
        else {
            this.videoError = new String[0];
        }
        this.showControls = jsonObject.optBoolean("showVideoPlayerControls");
        this.showCountdown = jsonObject.optBoolean("showCountdownHUD");
        this.reloadNonEndOverlayOnRestart = jsonObject.optBoolean("reloadOverlayOnRestart");
        final JSONObject optJSONObject = jsonObject.optJSONObject("onCompletion");
        if (optJSONObject != null) {
            this.onCompletionUrl = optJSONObject.optString("url", (String)null);
            this.stayInPlayer = optJSONObject.optBoolean("stayInPlayer");
        }
        this.duration = (long)(1000.0 * jsonObject.optDouble("duration", 0.0));
        this.contentLength = jsonObject.optLong("contentLength");
        this.closeDelayMillis = jsonObject.optLong("closeAfterDelay");
        final JSONArray optJSONArray6 = jsonObject.optJSONArray("buttons");
        if (optJSONArray6 != null) {
            for (int n2 = 0; n2 < optJSONArray6.length(); ++n2) {
                final JSONObject optJSONObject2 = optJSONArray6.optJSONObject(n2);
                if (optJSONObject2 != null) {
                    this.buttons.add(new VideoImage(optJSONObject2));
                }
            }
        }
        final JSONArray optJSONArray7 = jsonObject.optJSONArray("log");
        int n3 = 0;
        if (optJSONArray7 != null) {
            while (n3 < optJSONArray7.length()) {
                final JSONObject optJSONObject3 = optJSONArray7.optJSONObject(n3);
                if (optJSONObject3 != null) {
                    this.activities.add(new VideoLogEvent(optJSONObject3));
                }
                ++n3;
            }
        }
    }
    
    @Override
    boolean download(final Context context) {
        boolean downloadComponentExternalStorage = AdCache.downloadComponentExternalStorage(this.contentUrl, this.videoFileId + "video.dat", context);
        if (downloadComponentExternalStorage) {
            boolean downloadComponentInternalCache;
            for (int i = 0; i < this.buttons.size(); ++i, downloadComponentExternalStorage = downloadComponentInternalCache) {
                final VideoImage videoImage = this.buttons.get(i);
                downloadComponentInternalCache = AdCache.downloadComponentInternalCache(videoImage.imageUrl, this.getId() + videoImage.getImageName(), context);
                if (!downloadComponentInternalCache) {
                    downloadComponentExternalStorage = downloadComponentInternalCache;
                    break;
                }
            }
        }
        if (!downloadComponentExternalStorage) {
            if (this.downloadAllOrNothing) {
                this.delete(context);
            }
            HttpGetRequest.log(this.cacheFailed);
        }
        else if (downloadComponentExternalStorage) {
            if (this.acid != null && this.acid.length() > 0) {
                AdCache.cachedVideoWasAdded(context, this.acid);
            }
            HttpGetRequest.log(this.cacheComplete);
        }
        MMLog.v("VideoAd", String.format("Caching completed successfully? %b", downloadComponentExternalStorage));
        return downloadComponentExternalStorage;
    }
    
    @Override
    int getType() {
        return 1;
    }
    
    @Override
    String getTypeString() {
        return "Video";
    }
    
    Intent getVideoExtrasIntent(final Context context, final long n) {
        final Intent intent = new Intent();
        intent.putExtra("videoId", this.getId());
        if (n != -4L) {
            intent.putExtra("internalId", n);
        }
        intent.setData(Uri.parse(AdCache.getExternalCacheDirectory(context).getAbsolutePath() + File.separator + this.videoFileId + "video.dat"));
        return intent;
    }
    
    boolean hasEndCard() {
        final Iterator<VideoImage> iterator = this.buttons.iterator();
        while (iterator.hasNext()) {
            if (iterator.next().isLeaveBehind) {
                return true;
            }
        }
        return false;
    }
    
    @Override
    boolean isOnDisk(final Context context) {
        final int n = 1 + this.buttons.size();
        final File internalCacheDirectory = AdCache.getInternalCacheDirectory(context);
        final File externalCacheDirectory = AdCache.getExternalCacheDirectory(context);
        if (internalCacheDirectory != null && externalCacheDirectory != null) {
            final String[] list = internalCacheDirectory.list(new VideoAd$VideoFilenameFilter(this));
            final boolean b = list != null && list.length >= n;
            if (b && externalCacheDirectory != null) {
                if (!new File(externalCacheDirectory, this.videoFileId + "video.dat").exists()) {
                    return false;
                }
                final Iterator<VideoImage> iterator = this.buttons.iterator();
                while (iterator.hasNext()) {
                    if (!new File(internalCacheDirectory, this.getId() + iterator.next().getImageName()).exists()) {
                        return false;
                    }
                }
            }
            return b;
        }
        return false;
    }
    
    void logBeginEvent() {
        if (this.startActivity != null) {
            MMLog.d("VideoAd", "Cached video begin event logged");
            for (int i = 0; i < this.startActivity.length; ++i) {
                MMSDK$Event.logEvent(this.startActivity[i]);
            }
        }
    }
    
    void logEndEvent() {
        if (this.endActivity != null) {
            MMLog.d("VideoAd", "Cached video end event logged");
            for (int i = 0; i < this.endActivity.length; ++i) {
                MMSDK$Event.logEvent(this.endActivity[i]);
            }
        }
    }
    
    @Override
    public void readExternal(final ObjectInput objectInput) {
        int i = 0;
        super.readExternal(objectInput);
        this.showControls = objectInput.readBoolean();
        this.onCompletionUrl = (String)objectInput.readObject();
        this.webOverlayURL = (String)objectInput.readObject();
        this.endOverlayURL = (String)objectInput.readObject();
        this.cacheMissURL = (String)objectInput.readObject();
        this.videoFileId = (String)objectInput.readObject();
        this.stayInPlayer = objectInput.readBoolean();
        this.showCountdown = objectInput.readBoolean();
        this.reloadNonEndOverlayOnRestart = objectInput.readBoolean();
        final int int1 = objectInput.readInt();
        this.startActivity = new String[int1];
        for (int j = 0; j < int1; ++j) {
            this.startActivity[j] = (String)objectInput.readObject();
        }
        final int int2 = objectInput.readInt();
        this.endActivity = new String[int2];
        for (int k = 0; k < int2; ++k) {
            this.endActivity[k] = (String)objectInput.readObject();
        }
        this.duration = objectInput.readLong();
        this.usingInternalStorage = objectInput.readBoolean();
        this.contentLength = objectInput.readLong();
        this.closeDelayMillis = objectInput.readLong();
        final int int3 = objectInput.readInt();
        this.cacheComplete = new String[int3];
        for (int l = 0; l < int3; ++l) {
            this.cacheComplete[l] = (String)objectInput.readObject();
        }
        final int int4 = objectInput.readInt();
        this.cacheFailed = new String[int4];
        for (int n = 0; n < int4; ++n) {
            this.cacheFailed[n] = (String)objectInput.readObject();
        }
        final int int5 = objectInput.readInt();
        this.videoError = new String[int5];
        for (int n2 = 0; n2 < int5; ++n2) {
            this.videoError[n2] = (String)objectInput.readObject();
        }
        this.buttons.clear();
        for (int int6 = objectInput.readInt(), n3 = 0; n3 < int6; ++n3) {
            this.buttons.add(objectInput.readObject());
        }
        this.activities.clear();
        while (i < objectInput.readInt()) {
            this.activities.add(objectInput.readObject());
            ++i;
        }
    }
    
    @Override
    boolean saveAssets(final Context context) {
        return true;
    }
    
    void setDtoCachedVideo(final DTOCachedVideo cachedVideoDto) {
        this.cachedVideoDto = cachedVideoDto;
    }
    
    @Override
    void show(final Context context, final long n) {
        Utils$IntentUtils.startCachedVideoPlayerActivity(context, this.getVideoExtrasIntent(context, n));
    }
    
    @Override
    public void writeExternal(final ObjectOutput objectOutput) {
        int i = 0;
        super.writeExternal(objectOutput);
        objectOutput.writeBoolean(this.showControls);
        objectOutput.writeObject(this.onCompletionUrl);
        objectOutput.writeObject(this.webOverlayURL);
        objectOutput.writeObject(this.endOverlayURL);
        objectOutput.writeObject(this.cacheMissURL);
        objectOutput.writeObject(this.videoFileId);
        objectOutput.writeBoolean(this.stayInPlayer);
        objectOutput.writeBoolean(this.showCountdown);
        objectOutput.writeBoolean(this.reloadNonEndOverlayOnRestart);
        objectOutput.writeInt(this.startActivity.length);
        final String[] startActivity = this.startActivity;
        for (int length = startActivity.length, j = 0; j < length; ++j) {
            objectOutput.writeObject(startActivity[j]);
        }
        objectOutput.writeInt(this.endActivity.length);
        final String[] endActivity = this.endActivity;
        for (int length2 = endActivity.length, k = 0; k < length2; ++k) {
            objectOutput.writeObject(endActivity[k]);
        }
        objectOutput.writeLong(this.duration);
        objectOutput.writeBoolean(this.usingInternalStorage);
        objectOutput.writeLong(this.contentLength);
        objectOutput.writeLong(this.closeDelayMillis);
        objectOutput.writeInt(this.cacheComplete.length);
        final String[] cacheComplete = this.cacheComplete;
        for (int length3 = cacheComplete.length, l = 0; l < length3; ++l) {
            objectOutput.writeObject(cacheComplete[l]);
        }
        objectOutput.writeInt(this.cacheFailed.length);
        final String[] cacheFailed = this.cacheFailed;
        for (int length4 = cacheFailed.length, n = 0; n < length4; ++n) {
            objectOutput.writeObject(cacheFailed[n]);
        }
        objectOutput.writeInt(this.videoError.length);
        for (String[] videoError = this.videoError; i < videoError.length; ++i) {
            objectOutput.writeObject(videoError[i]);
        }
        objectOutput.writeInt(this.buttons.size());
        final Iterator<VideoImage> iterator = (Iterator<VideoImage>)this.buttons.iterator();
        while (iterator.hasNext()) {
            objectOutput.writeObject(iterator.next());
        }
        objectOutput.writeInt(this.activities.size());
        final Iterator<VideoLogEvent> iterator2 = (Iterator<VideoLogEvent>)this.activities.iterator();
        while (iterator2.hasNext()) {
            objectOutput.writeObject(iterator2.next());
        }
    }
    
    public void writeToParcel(final Parcel parcel, final int n) {
        super.writeToParcel(parcel, n);
        parcel.writeInt(this.startActivity.length);
        parcel.writeStringArray(this.startActivity);
        parcel.writeInt(this.endActivity.length);
        parcel.writeStringArray(this.endActivity);
        parcel.writeBooleanArray(new boolean[] { this.showControls, this.stayInPlayer, this.showCountdown, this.reloadNonEndOverlayOnRestart, this.usingInternalStorage });
        parcel.writeString(this.onCompletionUrl);
        parcel.writeString(this.endOverlayURL);
        parcel.writeString(this.webOverlayURL);
        parcel.writeString(this.cacheMissURL);
        parcel.writeString(this.videoFileId);
        parcel.writeLong(this.duration);
        parcel.writeLong(this.contentLength);
        parcel.writeLong(this.closeDelayMillis);
        parcel.writeList((List)this.buttons);
        parcel.writeList((List)this.activities);
        parcel.writeInt(this.cacheComplete.length);
        parcel.writeStringArray(this.cacheComplete);
        parcel.writeInt(this.cacheFailed.length);
        parcel.writeStringArray(this.cacheFailed);
        parcel.writeInt(this.videoError.length);
        parcel.writeStringArray(this.videoError);
    }
}
