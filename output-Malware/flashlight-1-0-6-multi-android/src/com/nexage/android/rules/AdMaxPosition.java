// 
// Decompiled by Procyon v0.5.30
// 

package com.nexage.android.rules;

import com.nexage.android.reports2.AdService2;
import com.nexage.android.interstitial.InterstitialLayout;
import com.nexage.android.internal.NexageAdFetcher;
import com.nexage.android.sdkmanager.GenericSDKAd;
import com.nexage.android.reports2.ReportManager;
import com.nexage.android.internal.Ad;
import com.nexage.android.internal.NexageContext;
import android.net.NetworkInfo;
import android.net.ConnectivityManager;
import android.content.Context;
import com.nexage.android.NexageAdManager;
import android.app.Activity;
import org.json.JSONArray;
import com.nexage.android.internal.NexageLog;
import org.json.JSONObject;
import android.app.ActivityManager$MemoryInfo;
import android.app.ActivityManager;

public class AdMaxPosition
{
    private static final String TAG = "AMP";
    private static ActivityManager s_ActivityManager;
    private static boolean s_CanCheck;
    private static ActivityManager$MemoryInfo s_MemInfo;
    public AdTag[] adTags;
    private boolean firstTime;
    private String jsonString;
    public String name;
    
    static {
        AdMaxPosition.s_ActivityManager = null;
        AdMaxPosition.s_MemInfo = null;
        AdMaxPosition.s_CanCheck = true;
    }
    
    public AdMaxPosition() {
        this.firstTime = true;
    }
    
    static AdMaxPosition fromJson(final JSONObject jsonObject) {
        final AdMaxPosition adMaxPosition = new AdMaxPosition();
        adMaxPosition.name = jsonObject.getString("name");
        final JSONArray jsonArray = jsonObject.getJSONArray("adTags");
        final int length = jsonArray.length();
        adMaxPosition.adTags = new AdTag[length];
        for (int i = 0; i < length; ++i) {
            adMaxPosition.adTags[i] = AdTag.fromJson(jsonArray.getJSONObject(i));
        }
        if (NexageLog.VERBOSE_LOG) {
            adMaxPosition.jsonString = jsonObject.toString(2);
        }
        return adMaxPosition;
    }
    
    public static boolean isLowMemory(final Activity activity) {
        synchronized (AdMaxPosition.class) {
            if (AdMaxPosition.s_ActivityManager == null) {
                AdMaxPosition.s_ActivityManager = (ActivityManager)activity.getSystemService("activity");
                AdMaxPosition.s_MemInfo = new ActivityManager$MemoryInfo();
            }
            AdMaxPosition.s_ActivityManager.getMemoryInfo(AdMaxPosition.s_MemInfo);
            NexageLog.v("s_MemInfo.lowMemory " + AdMaxPosition.s_MemInfo.lowMemory);
            NexageLog.v("s_MemInfo.availMem  " + AdMaxPosition.s_MemInfo.availMem);
            NexageLog.v("s_MemInfo.threshold " + AdMaxPosition.s_MemInfo.threshold);
            return AdMaxPosition.s_MemInfo.lowMemory || AdMaxPosition.s_MemInfo.availMem < AdMaxPosition.s_MemInfo.threshold + 1048576 * NexageAdManager.getVideoHeuristic();
        }
    }
    
    public static boolean isOffline(final Context context) {
        if (AdMaxPosition.s_CanCheck) {
            try {
                final NetworkInfo activeNetworkInfo = ((ConnectivityManager)context.getSystemService("connectivity")).getActiveNetworkInfo();
                AdMaxPosition.s_CanCheck = true;
                return activeNetworkInfo == null || !activeNetworkInfo.isAvailable() || !activeNetworkInfo.isConnected();
            }
            catch (SecurityException ex) {
                AdMaxPosition.s_CanCheck = false;
            }
        }
        return false;
    }
    
    public Ad fetchAd(final NexageContext nexageContext, final Activity activity, final boolean b) {
        NexageLog.i("AMP", "entering fetchAd");
        final InterstitialLayout interstitialLayout = nexageContext.interstitialLayout();
        Label_0069: {
            if (!isOffline((Context)activity)) {
                break Label_0069;
            }
            NexageLog.i(this.name, "Fetch Ad: device offline");
        Label_0351_Outer:
            while (true) {
                try {
                    try {
                        do {
                            this.wait(10000L);
                            if (interstitialLayout != null) {
                                return null;
                            }
                        } while (isOffline((Context)activity));
                        // monitorexit(this)
                        NexageLog.i(this.name, "Fetch Ad: device online");
                        if (interstitialLayout != null && isLowMemory(activity)) {
                            NexageLog.w(this.name, "Low memory: discard interstitial request");
                            return null;
                        }
                    }
                    finally {
                    }
                    // monitorexit(this)
                    long n = 0L;
                    final AdService2 service = ReportManager.getService(this.name);
                    NexageLog.setThreadLabel(new StringBuilder().append(service.getTimestamp() % 10000L).toString());
                    int i = 0;
                    Ad ad = null;
                Label_0351:
                    while (true) {
                        while (i < this.adTags.length) {
                            final AdTag adTag = this.adTags[i];
                            NexageLog.i("AMP", "current tag is " + i + " " + adTag.name + ":" + adTag.networkId + ":" + adTag.tagId);
                            final long currentTimeMillis = System.currentTimeMillis();
                            if (adTag.useSDK) {
                                if (b) {
                                    NexageLog.i(this.name, "Network " + adTag.networkId + " does not support expandable ads");
                                }
                                else {
                                    ad = new GenericSDKAd(nexageContext, service, adTag, 7500);
                                    if (ad.getLayout(activity) != null) {
                                        break Label_0351;
                                    }
                                    ad = null;
                                }
                            }
                            else {
                                ad = NexageAdFetcher.getAd(nexageContext, service, activity, this.name, adTag, 7500);
                                if (ad != null) {
                                    break Label_0351;
                                }
                                NexageLog.i("AMP", "Did not receive (URL) AD");
                            }
                            ++i;
                            n = currentTimeMillis;
                            continue Label_0351_Outer;
                            ReportManager.requestCompleted(service);
                            if (ad != null) {
                                NexageLog.i("AMP", "Got AD in (" + (System.currentTimeMillis() - currentTimeMillis) + " ms)");
                            }
                            NexageLog.clearThreadLabel();
                            return ad;
                        }
                        final long currentTimeMillis = n;
                        continue Label_0351;
                    }
                }
                catch (InterruptedException ex) {
                    continue;
                }
                break;
            }
        }
    }
    // monitorenter(this)
    
    public String getJsonString() {
        return this.name + ": " + this.jsonString;
    }
    
    public void logJsonString() {
        if (NexageLog.VERBOSE_LOG && this.firstTime) {
            NexageLog.i("json tag info for position: " + this.name + ": " + this.jsonString);
            this.firstTime = false;
        }
    }
    
    @Override
    public String toString() {
        return this.name;
    }
}
