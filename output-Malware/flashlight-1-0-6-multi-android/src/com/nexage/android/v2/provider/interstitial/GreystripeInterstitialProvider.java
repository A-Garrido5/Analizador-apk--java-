// 
// Decompiled by Procyon v0.5.30
// 

package com.nexage.android.v2.provider.interstitial;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import com.nexage.android.NexageAdManager;
import com.nexage.android.v2.TagInfo;
import com.nexage.android.reports2.ReportManager;
import com.nexage.android.internal.NexageGlobalHandler;
import android.app.Activity;
import android.location.Location;
import com.nexage.android.internal.NexageLog;
import com.nexage.android.v2.Task;
import android.content.Context;
import java.lang.reflect.Method;
import java.lang.reflect.Constructor;
import com.nexage.android.v2.provider.BaseProvider;

public class GreystripeInterstitialProvider extends BaseProvider implements InterstitialProvider
{
    public static final String TAG = "GreystripeIntProvider";
    private Class GSAdListenerClass;
    private Class GSFullscreenAdClass;
    private Constructor GSFullscreenAdConstructor;
    private Class GSSdkInfoClass;
    private Method addListenerMethod;
    private Context context;
    private Method displayMethod;
    private Method fetchMethod;
    private Method getVersionMethod;
    private Object gsAdListenerProxy;
    private Object gsFullscreenAd;
    private Method isAdReadyMethod;
    private Method removeListenerMethod;
    private Task task;
    private Method updateLocationMethod;
    
    public GreystripeInterstitialProvider() {
        NexageLog.d("GreystripeIntProvider", "entering constructor");
        try {
            this.GSSdkInfoClass = Class.forName("com.greystripe.sdk.GSSdkInfo");
            this.getVersionMethod = this.GSSdkInfoClass.getDeclaredMethod("getVersion", (Class[])new Class[0]);
            this.updateLocationMethod = this.GSSdkInfoClass.getDeclaredMethod("updateLocation", Location.class);
            this.GSAdListenerClass = Class.forName("com.greystripe.sdk.GSAdListener");
            this.GSFullscreenAdClass = Class.forName("com.greystripe.sdk.GSFullscreenAd");
            this.GSFullscreenAdConstructor = this.GSFullscreenAdClass.getConstructor(Context.class, String.class);
            this.addListenerMethod = this.GSFullscreenAdClass.getDeclaredMethod("addListener", this.GSAdListenerClass);
            this.displayMethod = this.GSFullscreenAdClass.getDeclaredMethod("display", (Class[])new Class[0]);
            this.fetchMethod = this.GSFullscreenAdClass.getDeclaredMethod("fetch", (Class[])new Class[0]);
            this.isAdReadyMethod = this.GSFullscreenAdClass.getDeclaredMethod("isAdReady", (Class[])new Class[0]);
            this.removeListenerMethod = this.GSFullscreenAdClass.getDeclaredMethod("removeListener", this.GSAdListenerClass);
            final String s = (String)this.getVersionMethod.invoke(null, new Object[0]);
            this.isSdkInitialized = true;
            NexageLog.d("GreystripeIntProvider", "SDK is initialized using Greystripe version " + s);
        }
        catch (Exception ex) {
            NexageLog.e("GreystripeIntProvider", "Failed to initialize Greystripe SDK.");
            NexageLog.e("GreystripeIntProvider", "Make sure that the Greystripe SDK JAR is in your classpath.");
            NexageLog.e("GreystripeIntProvider", "Failed here:", ex);
        }
    }
    
    @Override
    public void cancel() {
        NexageLog.d("GreystripeIntProvider", "entering cancel");
        if (!this.isSdkInitialized) {
            return;
        }
        try {
            if (this.gsFullscreenAd != null && this.gsAdListenerProxy != null) {
                this.removeListenerMethod.invoke(this.gsFullscreenAd, this.gsAdListenerProxy);
            }
        }
        catch (Exception ex) {
            NexageLog.w("GreystripeIntProvider", "cancel failed " + ex.getLocalizedMessage());
        }
    }
    
    @Override
    public void display(final Task task) {
        if (!this.isSdkInitialized || this.context == null) {
            NexageLog.e("GreystripeIntProvider", "display failed");
            return;
        }
        ((Activity)this.context).runOnUiThread((Runnable)new Runnable() {
            @Override
            public void run() {
                try {
                    if (GreystripeInterstitialProvider.this.isAdReadyMethod.invoke(GreystripeInterstitialProvider.this.gsFullscreenAd, new Object[0])) {
                        GreystripeInterstitialProvider.this.displayMethod.invoke(GreystripeInterstitialProvider.this.gsFullscreenAd, new Object[0]);
                        NexageGlobalHandler.setGlobalAdServingEnabled(false);
                        ReportManager.addDisplayEvent(task.adService, task);
                        task.displayed = true;
                        NexageLog.d("GreystripeIntProvider", "showing...");
                        return;
                    }
                    NexageLog.d("GreystripeIntProvider", "not ready to show");
                }
                catch (Exception ex) {
                    NexageLog.e("GreystripeIntProvider", "display failed", ex);
                }
            }
        });
    }
    
    @Override
    public void getAd(final Context context, final Task task) {
        NexageLog.d("GreystripeIntProvider", "entering getAd");
        if (!this.isSdkInitialized || context == null || task == null) {
            this.fireAdFailed(task);
            return;
        }
        this.context = context;
        this.task = task;
        ((Activity)context).runOnUiThread((Runnable)new Runnable() {
            @Override
            public void run() {
                try {
                    NexageLog.d("GreystripeIntProvider", "starting getAd thread");
                    if (NexageAdManager.getLocationAwareness() != null) {
                        GreystripeInterstitialProvider.this.updateLocationMethod.invoke(null, NexageAdManager.getLocationAwareness().getLocation());
                    }
                    GreystripeInterstitialProvider.this.gsFullscreenAd = GreystripeInterstitialProvider.this.GSFullscreenAdConstructor.newInstance(context, task.adTag.siteId);
                    GreystripeInterstitialProvider.this.gsAdListenerProxy = Proxy.newProxyInstance(GreystripeInterstitialProvider.this.GSAdListenerClass.getClassLoader(), new Class[] { GreystripeInterstitialProvider.this.GSAdListenerClass }, new GreystripeInterstitialProvider$GSAdListenerHandler(GreystripeInterstitialProvider.this, null));
                    GreystripeInterstitialProvider.this.addListenerMethod.invoke(GreystripeInterstitialProvider.this.gsFullscreenAd, GreystripeInterstitialProvider.this.gsAdListenerProxy);
                    GreystripeInterstitialProvider.this.fetchMethod.invoke(GreystripeInterstitialProvider.this.gsFullscreenAd, new Object[0]);
                    NexageLog.d("GreystripeIntProvider", "exiting getAd");
                }
                catch (Exception ex) {
                    NexageLog.e("GreystripeIntProvider", "getAd failed", ex);
                    GreystripeInterstitialProvider.this.fireAdFailed(task);
                }
            }
        });
    }
    
    @Override
    public String getProviderId() {
        // monitorenter(this)
        // monitorexit(this)
        return "GREYSTRIPE";
    }
}
