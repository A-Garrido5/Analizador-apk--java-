// 
// Decompiled by Procyon v0.5.30
// 

package com.nexage.ormma.controller;

import android.net.NetworkInfo$State;
import android.content.BroadcastReceiver;
import android.net.NetworkInfo;
import android.util.Log;
import android.content.Context;
import com.nexage.ormma.view.OrmmaView;
import android.content.IntentFilter;
import android.net.ConnectivityManager;
import com.nexage.ormma.controller.util.OrmmaNetworkBroadcastReceiver;

public class OrmmaNetworkController extends OrmmaController
{
    private static final String LOG_TAG = "OrmmaNetworkController";
    private OrmmaNetworkBroadcastReceiver mBroadCastReceiver;
    private ConnectivityManager mConnectivityManager;
    private IntentFilter mFilter;
    private int mNetworkListenerCount;
    
    public OrmmaNetworkController(final OrmmaView ormmaView, final Context context) {
        super(ormmaView, context);
        this.mConnectivityManager = (ConnectivityManager)context.getSystemService("connectivity");
    }
    
    public String getNetwork() {
        final NetworkInfo activeNetworkInfo = this.mConnectivityManager.getActiveNetworkInfo();
        String s = "unknown";
        if (activeNetworkInfo == null) {
            s = "offline";
        }
        else {
            switch (activeNetworkInfo.getState()) {
                default: {
                    final int type = activeNetworkInfo.getType();
                    if (type == 0) {
                        s = "cell";
                        break;
                    }
                    if (type == 1) {
                        s = "wifi";
                        break;
                    }
                    break;
                }
                case UNKNOWN: {
                    s = "unknown";
                    break;
                }
                case DISCONNECTED: {
                    s = "offline";
                    break;
                }
            }
        }
        Log.d("OrmmaNetworkController", "getNetwork: " + s);
        return s;
    }
    
    public void onConnectionChanged() {
        final String string = "window.ormmaview.fireChangeEvent({ network: '" + this.getNetwork() + "'});";
        Log.d("OrmmaNetworkController", string);
        this.mOrmmaView.injectJavaScript(string);
    }
    
    public void startNetworkListener() {
        if (this.mNetworkListenerCount == 0) {
            this.mBroadCastReceiver = new OrmmaNetworkBroadcastReceiver(this);
            (this.mFilter = new IntentFilter()).addAction("android.net.conn.CONNECTIVITY_CHANGE");
        }
        ++this.mNetworkListenerCount;
        this.mContext.registerReceiver((BroadcastReceiver)this.mBroadCastReceiver, this.mFilter);
    }
    
    @Override
    public void stopAllListeners() {
        this.mNetworkListenerCount = 0;
        try {
            this.mContext.unregisterReceiver((BroadcastReceiver)this.mBroadCastReceiver);
        }
        catch (Exception ex) {}
    }
    
    public void stopNetworkListener() {
        --this.mNetworkListenerCount;
        if (this.mNetworkListenerCount == 0) {
            this.mContext.unregisterReceiver((BroadcastReceiver)this.mBroadCastReceiver);
            this.mBroadCastReceiver = null;
            this.mFilter = null;
        }
    }
}
