// 
// Decompiled by Procyon v0.5.30
// 

package com.google.analytics.tracking.android;

import android.text.TextUtils;
import android.app.Activity;
import com.google.android.gms.common.util.VisibleForTesting;
import java.util.HashMap;
import java.util.TimerTask;
import java.util.Timer;
import android.content.Context;
import java.util.Map;

public class EasyTracker
{
    static final int NUM_MILLISECONDS_TO_WAIT_FOR_OPEN_ACTIVITY = 1000;
    private static EasyTracker sInstance;
    private int mActivitiesActive;
    private final Map mActivityNameMap;
    private GoogleAnalytics mAnalyticsInstance;
    private String mAppName;
    private String mAppVersion;
    private Clock mClock;
    private Context mContext;
    private boolean mDebug;
    private int mDispatchPeriod;
    private Thread.UncaughtExceptionHandler mExceptionHandler;
    private boolean mIsAnonymizeIpEnabled;
    private boolean mIsAutoActivityTracking;
    private boolean mIsEnabled;
    private boolean mIsInForeground;
    private boolean mIsReportUncaughtExceptionsEnabled;
    private long mLastOnStopTime;
    private ParameterLoader mParameterFetcher;
    private Double mSampleRate;
    private ServiceManager mServiceManager;
    private long mSessionTimeout;
    private Timer mTimer;
    private TimerTask mTimerTask;
    private Tracker mTracker;
    private String mTrackingId;
    
    private EasyTracker() {
        this.mIsEnabled = false;
        this.mDispatchPeriod = 1800;
        this.mIsAutoActivityTracking = false;
        this.mActivitiesActive = 0;
        this.mActivityNameMap = new HashMap();
        this.mTracker = null;
        this.mIsInForeground = false;
        this.mClock = new Clock() {
            @Override
            public long currentTimeMillis() {
                return System.currentTimeMillis();
            }
        };
    }
    
    private void clearExistingTimer() {
        synchronized (this) {
            if (this.mTimer != null) {
                this.mTimer.cancel();
                this.mTimer = null;
            }
        }
    }
    
    @VisibleForTesting
    static void clearTracker() {
        EasyTracker.sInstance = null;
    }
    
    private String getActivityName(final Activity activity) {
        final String canonicalName = activity.getClass().getCanonicalName();
        if (this.mActivityNameMap.containsKey(canonicalName)) {
            return (String)this.mActivityNameMap.get(canonicalName);
        }
        String string = this.mParameterFetcher.getString(canonicalName);
        if (string == null) {
            string = canonicalName;
        }
        this.mActivityNameMap.put(canonicalName, string);
        return string;
    }
    
    public static EasyTracker getInstance() {
        if (EasyTracker.sInstance == null) {
            EasyTracker.sInstance = new EasyTracker();
        }
        return EasyTracker.sInstance;
    }
    
    public static Tracker getTracker() {
        if (getInstance().mContext == null) {
            throw new IllegalStateException("You must call EasyTracker.getInstance().setContext(context) or startActivity(activity) before calling getTracker()");
        }
        return getInstance().mTracker;
    }
    
    private void loadParameters() {
        boolean b = true;
        this.mTrackingId = this.mParameterFetcher.getString("ga_trackingId");
        Label_0071: {
            if (!TextUtils.isEmpty((CharSequence)this.mTrackingId)) {
                break Label_0071;
            }
            this.mTrackingId = this.mParameterFetcher.getString("ga_api_key");
            if (!TextUtils.isEmpty((CharSequence)this.mTrackingId)) {
                break Label_0071;
            }
            Log.e("EasyTracker requested, but missing required ga_trackingId");
            this.mTracker = new EasyTracker$NoopTracker(this);
            return;
        }
        this.mIsEnabled = b;
        this.mAppName = this.mParameterFetcher.getString("ga_appName");
        this.mAppVersion = this.mParameterFetcher.getString("ga_appVersion");
        this.mDebug = this.mParameterFetcher.getBoolean("ga_debug");
        this.mSampleRate = this.mParameterFetcher.getDoubleFromString("ga_sampleFrequency");
        if (this.mSampleRate == null) {
            this.mSampleRate = new Double(this.mParameterFetcher.getInt("ga_sampleRate", 100));
        }
        this.mDispatchPeriod = this.mParameterFetcher.getInt("ga_dispatchPeriod", 1800);
        this.mSessionTimeout = 1000 * this.mParameterFetcher.getInt("ga_sessionTimeout", 30);
        if (!this.mParameterFetcher.getBoolean("ga_autoActivityTracking") && !this.mParameterFetcher.getBoolean("ga_auto_activity_tracking")) {
            b = false;
        }
        this.mIsAutoActivityTracking = b;
        this.mIsAnonymizeIpEnabled = this.mParameterFetcher.getBoolean("ga_anonymizeIp");
        this.mIsReportUncaughtExceptionsEnabled = this.mParameterFetcher.getBoolean("ga_reportUncaughtExceptions");
        this.mTracker = this.mAnalyticsInstance.getTracker(this.mTrackingId);
        if (!TextUtils.isEmpty((CharSequence)this.mAppName)) {
            Log.i("setting appName to " + this.mAppName);
            this.mTracker.setAppName(this.mAppName);
        }
        if (this.mAppVersion != null) {
            this.mTracker.setAppVersion(this.mAppVersion);
        }
        this.mTracker.setAnonymizeIp(this.mIsAnonymizeIpEnabled);
        this.mTracker.setSampleRate(this.mSampleRate);
        this.mAnalyticsInstance.setDebug(this.mDebug);
        this.mServiceManager.setDispatchPeriod(this.mDispatchPeriod);
        if (this.mIsReportUncaughtExceptionsEnabled) {
            Thread.UncaughtExceptionHandler mExceptionHandler = this.mExceptionHandler;
            if (mExceptionHandler == null) {
                mExceptionHandler = new ExceptionReporter(this.mTracker, this.mServiceManager, Thread.getDefaultUncaughtExceptionHandler());
            }
            Thread.setDefaultUncaughtExceptionHandler(mExceptionHandler);
        }
    }
    
    public void activityStart(final Activity context) {
        this.setContext((Context)context);
        if (this.mIsEnabled) {
            this.clearExistingTimer();
            if (!this.mIsInForeground && this.mActivitiesActive == 0 && this.checkForNewSession()) {
                this.mTracker.setStartSession(true);
                final boolean mIsAutoActivityTracking = this.mIsAutoActivityTracking;
            }
            this.mIsInForeground = true;
            ++this.mActivitiesActive;
            if (this.mIsAutoActivityTracking) {
                this.mTracker.sendView(this.getActivityName(context));
            }
        }
    }
    
    public void activityStop(final Activity context) {
        this.setContext((Context)context);
        if (this.mIsEnabled) {
            --this.mActivitiesActive;
            this.mActivitiesActive = Math.max(0, this.mActivitiesActive);
            this.mLastOnStopTime = this.mClock.currentTimeMillis();
            if (this.mActivitiesActive == 0) {
                this.clearExistingTimer();
                this.mTimerTask = new EasyTracker$NotInForegroundTimerTask(this, null);
                (this.mTimer = new Timer("waitForActivityStart")).schedule(this.mTimerTask, 1000L);
            }
        }
    }
    
    boolean checkForNewSession() {
        return this.mSessionTimeout == 0L || (this.mSessionTimeout > 0L && this.mClock.currentTimeMillis() > this.mLastOnStopTime + this.mSessionTimeout);
    }
    
    public void dispatch() {
        if (this.mIsEnabled) {
            this.mServiceManager.dispatch();
        }
    }
    
    @VisibleForTesting
    int getActivitiesActive() {
        return this.mActivitiesActive;
    }
    
    @VisibleForTesting
    void setClock(final Clock mClock) {
        this.mClock = mClock;
    }
    
    public void setContext(final Context context) {
        if (context == null) {
            Log.e("Context cannot be null");
            return;
        }
        this.setContext(context, new ParameterLoaderImpl(context.getApplicationContext()), GoogleAnalytics.getInstance(context.getApplicationContext()), GAServiceManager.getInstance());
    }
    
    @VisibleForTesting
    void setContext(final Context context, final ParameterLoader mParameterFetcher, final GoogleAnalytics mAnalyticsInstance, final ServiceManager mServiceManager) {
        if (context == null) {
            Log.e("Context cannot be null");
        }
        if (this.mContext == null) {
            this.mContext = context.getApplicationContext();
            this.mAnalyticsInstance = mAnalyticsInstance;
            this.mServiceManager = mServiceManager;
            this.mParameterFetcher = mParameterFetcher;
            this.loadParameters();
        }
    }
    
    @VisibleForTesting
    void setUncaughtExceptionHandler(final Thread.UncaughtExceptionHandler mExceptionHandler) {
        this.mExceptionHandler = mExceptionHandler;
    }
}
